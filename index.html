<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>è‹¹æœæ°´å°ç”Ÿæˆå™¨</title>
  <script src="https://unpkg.com/exifr/dist/full.umd.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/opencc-js@1.0.5/dist/umd/full.js"></script>

  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", system-ui, sans-serif;
      background: #111;
      color: #eee;
    }
    .container {
      max-width: 960px;
      margin: 24px auto 40px;
      padding: 0 16px;
    }
    h1 { margin-bottom: 4px; text-align: center; }
    .tip {
      font-size: 13px;
      color: #aaa;
      text-align: center;
      margin-bottom: 16px;
    }
    
    /* å·¥å…·æ æ ·å¼ */
    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      justify-content: center;
      align-items: center;
      background: #1a1a1a;
      padding: 16px;
      border-radius: 12px;
      margin-bottom: 20px;
      border: 1px solid #333;
    }
    
    .control-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .upload-btn {
      display: inline-block;
      padding: 8px 16px;
      border-radius: 999px;
      background: #333;
      border: 1px solid #555;
      cursor: pointer;
      user-select: none;
      font-size: 14px;
      transition: all 0.2s;
    }
    .upload-btn:hover { background: #444; border-color: #777; }

    select {
      background: #222;
      border-radius: 6px;
      border: 1px solid #555;
      color: #eee;
      padding: 6px 10px;
      font-size: 13px;
      outline: none;
    }
    
    /* æ»‘åŠ¨æ¡æ ·å¼ */
    .slider-box {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 4px;
    }
    .slider-box label {
      font-size: 12px;
      color: #888;
    }
    input[type=range] {
      -webkit-appearance: none;
      width: 100px;
      height: 4px;
      background: #444;
      border-radius: 2px;
      outline: none;
    }
    input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: #0a84ff;
      cursor: pointer;
      border: 2px solid #1a1a1a;
    }

    .info-panel {
      margin: 8px auto 16px;
      font-size: 12px;
      color: #ccc;
      max-width: 760px;
      white-space: pre-line;
      text-align: center;
      opacity: 0.8;
    }
    
    .preview-wrapper {
      text-align: center;
      background: #000;
      padding: 20px;
      border-radius: 12px;
      border: 1px solid #333;
    }
    canvas {
      max-width: 100%;
      height: auto;
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
    }
    
    .download-btn {
      display: block;
      margin: 20px auto 0;
      padding: 12px 32px;
      border-radius: 999px;
      border: none;
      background: #0a84ff;
      color: #fff;
      cursor: pointer;
      font-size: 16px;
      font-weight: 500;
      transition: background 0.2s;
    }
    .download-btn:disabled {
      background: #444;
      color: #888;
      cursor: not-allowed;
    }
    .download-btn:hover:not(:disabled) {
      background: #0071e3;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>è‹¹æœæ°´å°ç”Ÿæˆå™¨</h1>
    <div class="toolbar">
      <label class="upload-btn">
        ğŸ“· é€‰æ‹©ç…§ç‰‡
        <input id="fileInput" type="file" accept="image/*" hidden>
      </label>

      <div class="control-group">
        <select id="themeSelect">
          <option value="dark-bar">ä¸»é¢˜ 1ï¼šæš—è‰²ç”µå½±æ„Ÿ (é»‘æ¡)</option>
          <option value="white-frame">ä¸»é¢˜ 2ï¼šæç®€ç”»å»Šé£ (ç™½æ¡†)</option>
        </select>
      </div>

      <div class="control-group" style="margin-left: 8px; border-left: 1px solid #444; padding-left: 16px;">
        <div class="slider-box">
          <label for="logoScale">Logo å¤§å°</label>
          <input type="range" id="logoScale" min="0.5" max="1.5" step="0.05" value="1">
        </div>
        <div class="slider-box">
          <label for="textScale">æ–‡å­—å¤§å°</label>
          <input type="range" id="textScale" min="0.5" max="1.5" step="0.05" value="1">
        </div>
      </div>
    </div>

    <div id="infoPanel" class="info-panel">ç­‰å¾…ä¸Šä¼ ç…§ç‰‡...</div>

    <div class="preview-wrapper">
      <canvas id="canvas"></canvas>
      <button id="downloadBtn" class="download-btn" disabled>ä¸‹è½½</button>
    </div>
  </div>

  <script>
    const fileInput = document.getElementById('fileInput');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const downloadBtn = document.getElementById('downloadBtn');
    const infoPanel = document.getElementById('infoPanel');
    const themeSelect = document.getElementById('themeSelect');
    const logoScaleInput = document.getElementById('logoScale');
    const textScaleInput = document.getElementById('textScale');
    const previewWrapper = document.querySelector('.preview-wrapper'); // è·å–å®¹å™¨

    const converter = OpenCC.Converter({ from: 't', to: 'cn' });

    // çŠ¶æ€ç®¡ç†
    let state = {
      theme: 'dark-bar',
      img: null,
      text: '',
      logoScale: 1.0,
      textScale: 1.0
    };
    // ç™½è‰² logoï¼ˆé€‚ç”¨äºé»‘æ¡ä¸»é¢˜ï¼‰
    const WHITE_LOGO_SVG = "data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+CjxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iODQyLjMyMDA3IiBoZWlnaHQ9IjEwMDAuMDAwMSI+CiAgPHBhdGggZmlsbD0iI2ZmZiIgZD0iTTgyNC42NjYzNiA3NzkuMzAzNjNjLTE1LjEyMjk5IDM0LjkzNzI0LTMzLjAyMzY4IDY3LjA5Njc0LTUzLjc2MzggOTYuNjYzNzQtMjguMjcwNzYgNDAuMzA3NC01MS40MTgyIDY4LjIwNzgtNjkuMjU3MTcgODMuNzAxMi0yNy42NTM0NyAyNS40MzEzLTU3LjI4MjIgMzguNDU1Ni04OS4wMDk2NCAzOS4xOTYzLTIyLjc3NzA4IDAtNTAuMjQ1MzktNi40ODEzLTgyLjIxOTczLTE5LjYyOS0zMi4wNzkyNi0xMy4wODYxLTYxLjU1OTg1LTE5LjU2NzMtODguNTE1ODMtMTkuNTY3My0yOC4yNzA3NSAwLTU4LjU5MDgzIDYuNDgxMi05MS4wMjE5MyAxOS41NjczLTMyLjQ4MDUzIDEzLjE0NzctNTguNjQ2MzkgMTkuOTk5NC03OC42NTE5NiAyMC42Nzg0LTMwLjQyNTAxIDEuMjk2MjMtNjAuNzUxMjMtMTIuMDk4NS05MS4wMjE5My00MC4yNDU3LTE5LjMyMDM5LTE2Ljg1MTQtNDMuNDg2MzItNDUuNzM5NC03Mi40MzYwNy04Ni42NjQxLTMxLjA2MDc3OC00My43MDI0LTU2LjU5NzA0MS05NC4zNzk4My03Ni42MDI2MDktMTUyLjE1NTg2QzEwLjc0MDQxNiA2NTguNDQzMDkgMCA1OTguMDEyODMgMCA1MzkuNTA4NDVjMC02Ny4wMTY0OCAxNC40ODEwNDQtMTI0LjgxNzIgNDMuNDg2MzM2LTE3My4yNTQwMUM2Ni4yODE5NCAzMjcuMzQ4MjMgOTYuNjA4MTggMjk2LjY1NzggMTM0LjU2MzggMjc0LjEyNzZjMzcuOTU1NjYtMjIuNTMwMTYgNzguOTY2NzYtMzQuMDExMjkgMTIzLjEzMjEtMzQuNzQ1ODUgMjQuMTY1OTEgMCA1NS44NTYzMyA3LjQ3NTA4IDk1LjIzNzg0IDIyLjE2NiAzOS4yNzA0MiAxNC43NDAyOSA2NC40ODU3MSAyMi4yMTUzOCA3NS41NDA5MSAyMi4yMTUzOCA4LjI2NTE4IDAgMzYuMjc2NjgtOC43NDA1IDgzLjc2MjktMjYuMTY1ODcgNDQuOTA2MDctMTYuMTYwMDEgODIuODA2MTQtMjIuODUxMTggMTEzLjg1NDU4LTIwLjIxNTQ2IDg0LjEzMzI2IDYuNzg5OTIgMTQ3LjM0MTIyIDM5Ljk1NTU5IDE4OS4zNzY5OSA5OS43MDY4Ni03NS4yNDQ2MyA0NS41OTEyMi0xMTIuNDY1NzMgMTA5LjQ0NzMtMTExLjcyNTAyIDE5MS4zNjQ1Ni42Nzg5OSA2My44MDY3IDIzLjgyNjQzIDExNi45MDM4NCA2OS4zMTg4OCAxNTkuMDYzMDkgMjAuNjE2NjQgMTkuNTY3MjcgNDMuNjQwNjYgMzQuNjkwMjcgNjkuMjU3MSA0NS40MzA3LTUuNTU1MzEgMTYuMTEwNjItMTEuNDE5MzMgMzEuNTQyMjUtMTcuNjUzNzIgNDYuMzU2NjJ6TTYzMS43MDkyNiAyMC4wMDU3YzAgNTAuMDExNDEtMTguMjcxMDggOTYuNzA2OTMtNTQuNjg5NyAxMzkuOTI3ODItNDMuOTQ5MzIgNTEuMzgxMTgtOTcuMTA4MTcgODEuMDcxNjItMTU0Ljc1NDU5IDc2LjM4NjU5LS43MzQ1NC01Ljk5OTgzLTEuMTYwNDUtMTIuMzE0NDQtMS4xNjA0NS0xOC45NTAwMyAwLTQ4LjAxMDkxIDIwLjkwMDYtOTkuMzkyMDcgNTguMDE2NzgtMTQxLjQwMzE0IDE4LjUzMDI3LTIxLjI3MDk0IDQyLjA5NzQ2LTM4Ljk1NzQ0IDcwLjY3Njg1LTUzLjA2NjNDNTc4LjMxNTggOS4wMDIyOSA2MDUuMjkwMyAxLjMxNjIxIDYzMC42NTk4OCAwYy43NDA3NiA2LjY4NTc1IDEuMDQ5MzggMTMuMzcxOTEgMS4wNDkzOCAyMC4wMDUwNXoiLz4KPC9zdmc+";

    // é»‘è‰² logoï¼ˆé€‚ç”¨äºç™½æ¡†ä¸»é¢˜ï¼‰â€”â€”ä½ å¯ä»¥æŠŠè¿™é‡Œæ›¿æ¢æˆä½ æä¾›çš„é»‘è‰²ç‰ˆæœ¬
    const BLACK_LOGO_SVG = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbDpzcGFjZT0icHJlc2VydmUiIHdpZHRoPSI4MTQiIGhlaWdodD0iMTAwMCI+CiAgPHBhdGggZD0iTTc4OC4xIDM0MC45Yy01LjggNC41LTEwOC4yIDYyLjItMTA4LjIgMTkwLjUgMCAxNDguNCAxMzAuMyAyMDAuOSAxMzQuMiAyMDIuMi0uNiAzLjItMjAuNyA3MS45LTY4LjcgMTQxLjktNDIuOCA2MS42LTg3LjUgMTIzLjEtMTU1LjUgMTIzLjFzLTg1LjUtMzkuNS0xNjQtMzkuNWMtNzYuNSAwLTEwMy43IDQwLjgtMTY1LjkgNDAuOHMtMTA1LjYtNTctMTU1LjUtMTI3QzQ2LjcgNzkwLjcgMCA2NjMgMCA1NDEuOGMwLTE5NC40IDEyNi40LTI5Ny41IDI1MC44LTI5Ny41IDY2LjEgMCAxMjEuMiA0My40IDE2Mi43IDQzLjQgMzkuNSAwIDEwMS4xLTQ2IDE3Ni4zLTQ2IDI4LjUgMCAxMzAuOSAyLjYgMTk4LjMgOTkuMnptLTIzNC0xODEuNWMzMS4xLTM2LjkgNTMuMS04OC4xIDUzLjEtMTM5LjMgMC03LjEtLjYtMTQuMy0xLjktMjAuMS01MC42IDEuOS0xMTAuOCAzMy43LTE0Ny4xIDc1LjgtMjguNSAzMi40LTU1LjEgODMuNi01NS4xIDEzNS41IDAgNy44IDEuMyAxNS42IDEuOSAxOC4xIDMuMi42IDguNCAxLjMgMTMuNiAxLjMgNDUuNCAwIDEwMi41LTMwLjQgMTM1LjUtNzEuM3oiLz4KPC9zdmc+"

    // äº‹ä»¶ç›‘å¬
    fileInput.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;

      // é‡ç½®ç•Œé¢
      resetPreview();

      const img = await readImage(file);
      let exif = {};
      try {
        exif = await exifr.parse(file) || {};
      } catch (err) {
        console.warn('EXIF è§£æå¤±è´¥', err);
      }

      const meta = await buildMetadata(exif);
      infoPanel.textContent = meta.debugText;

      state.img = img;
      state.text = meta.displayText;

      render();
      downloadBtn.disabled = false;
      downloadBtn.textContent = 'ç”Ÿæˆå¹¶ä¸‹è½½å›¾ç‰‡'; // é‡ç½®æŒ‰é’®æ–‡å­—
    });

    themeSelect.addEventListener('change', (e) => {
      state.theme = e.target.value;
      if (state.img) {
        resetPreview(); // è°ƒæ•´å‚æ•°æ—¶åˆ‡å› Canvas é¢„è§ˆï¼Œæ›´æµç•…
        render();
      }
    });

    logoScaleInput.addEventListener('input', (e) => {
      state.logoScale = parseFloat(e.target.value);
      if (state.img) {
        resetPreview();
        render();
      }
    });

    textScaleInput.addEventListener('input', (e) => {
      state.textScale = parseFloat(e.target.value);
      if (state.img) {
        resetPreview();
        render();
      }
    });

    // è¾…åŠ©å‡½æ•°ï¼šé‡ç½®ä¸º Canvas é¢„è§ˆæ¨¡å¼ï¼ˆéšè—ç”Ÿæˆçš„ Imageï¼‰
    function resetPreview() {
      canvas.style.display = 'block';
      const existingImg = document.getElementById('resultImg');
      if (existingImg) existingImg.remove();
      downloadBtn.textContent = 'ä¸‹è½½æˆç‰‡';
    }

    // =========================================================
    // æ ¸å¿ƒä¿®æ”¹ï¼šä¸‹è½½æŒ‰é’®é€»è¾‘ï¼ˆå…¼å®¹æ‰‹æœºç«¯ï¼‰
    // =========================================================
    downloadBtn.addEventListener('click', () => {
      if (!state.img) return;
      
      downloadBtn.disabled = true;
      downloadBtn.textContent = 'å¤„ç†ä¸­...';

      // ä½¿ç”¨ toBlob æ›¿ä»£ toDataURL (è§£å†³å¤§å›¾å†…å­˜å´©æºƒé—®é¢˜)
      canvas.toBlob(function(blob) {
        if (!blob) {
          alert('ç”Ÿæˆå›¾ç‰‡å¤±è´¥ï¼Œå¯èƒ½æ˜¯å›¾ç‰‡åˆ†è¾¨ç‡è¿‡é«˜ï¼Œè¯·å°è¯•ä½¿ç”¨å°ä¸€ç‚¹çš„å›¾ç‰‡ã€‚');
          downloadBtn.disabled = false;
          downloadBtn.textContent = 'ä¸‹è½½æˆç‰‡';
          return;
        }

        const url = URL.createObjectURL(blob);

        // 1. å°è¯•è§¦å‘ä¸‹è½½
        const a = document.createElement('a');
        a.href = url;
        a.download = `watermark_${Date.now()}.jpg`;
        // å°è¯•è§¦å‘ç‚¹å‡»
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);

        // 2. æ— è®ºä¸‹è½½æ˜¯å¦æˆåŠŸï¼Œéƒ½åœ¨é¡µé¢ä¸Šæ˜¾ç¤ºè¿™ä¸€å¼ å›¾ç‰‡
        // è¿™æ ·å¦‚æœä¸‹è½½è¢«å¾®ä¿¡æ‹¦æˆªï¼Œç”¨æˆ·å¯ä»¥ç›´æ¥â€œé•¿æŒ‰ä¿å­˜â€
        resetPreview(); // å…ˆæ¸…ç†æ—§çš„
        
        const resultImg = new Image();
        resultImg.id = 'resultImg';
        resultImg.src = url;
        resultImg.style.maxWidth = '100%';
        resultImg.style.boxShadow = '0 4px 20px rgba(0,0,0,0.5)';
        resultImg.style.display = 'block';
        
        // éšè— canvasï¼Œæ˜¾ç¤ºå›¾ç‰‡
        canvas.style.display = 'none';
        previewWrapper.insertBefore(resultImg, canvas);

        // æ›´æ”¹æŒ‰é’®æç¤ºï¼Œå‘Šè¯‰ç”¨æˆ·è¯¥æ€ä¹ˆåš
        downloadBtn.textContent = 'å¦‚æœªå¼¹å‡ºä¸‹è½½ï¼Œè¯·é•¿æŒ‰ä¸Šæ–¹å›¾ç‰‡ä¿å­˜';
        downloadBtn.disabled = false;

        // 3. é’ˆå¯¹ iOS Safari çš„ç‰¹æ®Šå¤„ç†ï¼ˆæœ‰æ—¶éœ€è¦åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€ï¼‰
        // å¦‚æœæ˜¯ iOSï¼Œå¯èƒ½éœ€è¦ä¸€ç‚¹å»¶è¿Ÿæç¤º
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        if (isIOS) {
           // iOS ç”¨æˆ·ä¹ æƒ¯é•¿æŒ‰ï¼Œå·²ç»ç”Ÿæˆäº† Img æ ‡ç­¾ï¼Œä»–ä»¬ç°åœ¨å¯ä»¥é•¿æŒ‰äº†
        }

      }, 'image/jpeg', 0.92); // 0.92 è´¨é‡ï¼Œè¿›ä¸€æ­¥å‡å°‘ä½“ç§¯
    });

    // ç»Ÿä¸€æ¸²æŸ“å…¥å£
    function render() {
      if (state.theme === 'dark-bar') {
        drawThemeDarkBar(state.img, state.text);
      } else {
        drawThemeWhiteFrame(state.img, state.text);
      }
    }

    // è¾…åŠ©å‡½æ•°
    function readImage(file) {
      return new Promise((resolve, reject) => {
        const fr = new FileReader();
        fr.onload = () => {
          const img = new Image();
          img.onload = () => resolve(img);
          img.onerror = reject;
          img.src = fr.result;
        };
        fr.onerror = reject;
        fr.readAsDataURL(file);
      });
    }

    // å…ƒæ•°æ®è§£æ
    async function buildMetadata(exif) {
      const model = exif.Model || '';
      let fNumberText = exif.FNumber ? 'f/' + toNumber(exif.FNumber).toFixed(1) : '';
      const iso = exif.ISO || exif.PhotographicSensitivity || '';
      let shutterText = '';
      if (exif.ExposureTime) {
        const t = toNumber(exif.ExposureTime);
        if (t > 0) shutterText = t >= 1 ? t.toFixed(1) + 's' : '1/' + Math.round(1 / t) + 's';
      }
      let focalText = exif.FocalLength ? toNumber(exif.FocalLength).toFixed(0) + 'mm' : '';
      let dateText = '';
      if (exif.DateTimeOriginal) {
        dateText = String(exif.DateTimeOriginal).split(' ')[0].replace(/:/g, '-');
      }

      let gpsText = '';
      let locationName = '';
      if (exif.GPSLatitude && exif.GPSLongitude) {
        const lat = gpsToDecimal(exif.GPSLatitude, exif.GPSLatitudeRef);
        const lng = gpsToDecimal(exif.GPSLongitude, exif.GPSLongitudeRef);
        gpsText = lat.toFixed(4) + ', ' + lng.toFixed(4);
        try {
          locationName = await reverseGeocode(lat, lng);
        } catch (e) { console.warn(e); }
      }

      const parts = [];
      if (model) parts.push(model);
      if (focalText) parts.push(focalText);
      if (fNumberText) parts.push(fNumberText);
      if (iso) parts.push('ISO ' + iso);
      if (shutterText) parts.push(shutterText);
      if (locationName || gpsText) parts.push(locationName || gpsText);
      if (dateText) parts.push(dateText);

      return {
        displayText: parts.join(' Â· ') || 'Shot on iPhone',
        debugText: `è¯†åˆ«ä¿¡æ¯:\n${parts.join('\n')}`
      };
    }

    function toNumber(v) {
      if (typeof v === 'number') return v;
      if (v && v.numerator && v.denominator) return v.numerator / v.denominator;
      return Number(v) || 0;
    }

    function gpsToDecimal(arr, ref) {
      const d = toNumber(arr[0]), m = toNumber(arr[1]), s = toNumber(arr[2]);
      let res = d + m/60 + s/3600;
      return (ref === 'S' || ref === 'W') ? -res : res;
    }

    async function reverseGeocode(lat, lng) {
      const url = `https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lng}&localityLanguage=zh-CN`;
      const res = await fetch(url);
      if (!res.ok) return '';
      const d = await res.json();
      const region = d.principalSubdivision || '';
      const city = d.city || d.locality || '';
      return converter([region, city].filter(Boolean).join(' Â· '));
    }

    // æ–‡æœ¬æ’ç‰ˆå·¥å…·
    function layoutTextLines(fullText, maxWidth, fontSize) {
      if (!fullText) return [];
      const rawTokens = fullText.split(' Â· ');
      const lines = [];
      let currentLine = '';

      rawTokens.forEach((token, index) => {
        const separator = index === 0 ? '' : '  |  '; 
        const testLine = currentLine + separator + token;
        const metrics = ctx.measureText(testLine);
        
        if (metrics.width > maxWidth && index > 0) {
          lines.push(currentLine);
          currentLine = token;
        } else {
          currentLine = testLine;
        }
      });
      if (currentLine) lines.push(currentLine);

      if (lines.length > 2) {
        const first = lines[0];
        let second = lines.slice(1).join('  |  ');
        while (ctx.measureText(second + '...').width > maxWidth && second.length > 0) {
          second = second.slice(0, -1);
        }
        return [first, second + '...'];
      }
      return lines;
    }

    // =========================================================
    // THEME 1: é»‘æ¡ (ä¿æŒä¸å˜)
    // =========================================================
    function drawThemeDarkBar(img, text) {
      const imgW = img.naturalWidth;
      const imgH = img.naturalHeight;

      const logoImg = new Image();
      logoImg.onload = () => {
        canvas.width = imgW;
        canvas.height = imgH;
        // 1. ç”»åŸå›¾
        ctx.drawImage(img, 0, 0, imgW, imgH);

        // 2. åŸºå‡†å°ºå¯¸è®¡ç®—
        const baseRef = Math.max(24, imgW * 0.016); 
        
        // åº”ç”¨ç”¨æˆ·ç¼©æ”¾
        const finalFontSize = baseRef * state.textScale;
        // Logo 2.1å€
        const finalLogoTargetH = (baseRef * 2.1) * state.logoScale;

        // å­—ä½“è®¾ç½®
        ctx.font = `500 ${finalFontSize}px -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif`;
        ctx.textBaseline = 'middle';
        ctx.fillStyle = 'rgba(255, 255, 255, 0.95)';

        const horizontalPadding = imgW * 0.04;
        const maxTextWidth = imgW - horizontalPadding * 2;

        const lines = layoutTextLines(text, maxTextWidth, finalFontSize);

        // Logo å°ºå¯¸
        const scale = finalLogoTargetH / logoImg.height;
        const logoW = logoImg.width * scale;
        const logoH = logoImg.height * scale;

        // å¸ƒå±€å‚æ•° (è·Ÿéšå­—ä½“ç¼©æ”¾)
        const lineHeight = finalFontSize * 1.6;
        const gapLogoText = finalFontSize * 0.8;
        const paddingY = finalFontSize * 1.5;

        // å†…å®¹æ€»é«˜
        const contentHeight = logoH + gapLogoText + (lines.length * lineHeight) - (lineHeight - finalFontSize);
        const barHeight = contentHeight + paddingY * 2;
        const barTop = imgH - barHeight;

        // ç»˜åˆ¶é»‘æ¡
        ctx.fillStyle = 'rgba(0, 0, 0, 0.75)'; 
        ctx.fillRect(0, barTop, imgW, barHeight);

        // ç»˜åˆ¶ Logo
        const centerY = barTop + barHeight / 2;
        const startY = centerY - (contentHeight / 2);
        
        const logoX = (imgW - logoW) / 2;
        ctx.drawImage(logoImg, logoX, startY, logoW, logoH);

        // ç»˜åˆ¶æ–‡å­—
        ctx.fillStyle = '#f0f0f0';
        let textCurY = startY + logoH + gapLogoText + (finalFontSize / 2);

        lines.forEach((line) => {
          const w = ctx.measureText(line).width;
          const x = (imgW - w) / 2;
          ctx.fillText(line, x, textCurY);
          textCurY += lineHeight;
        });
      };
      logoImg.src = WHITE_LOGO_SVG;
    }

    // =========================================================
    // THEME 2: ç™½æ¡† (ä¿æŒä¸å˜)
    // =========================================================
    function drawThemeWhiteFrame(img, text) {
      const imgW = img.naturalWidth;
      const imgH = img.naturalHeight;
      const minSide = Math.min(imgW, imgH);

      const logoImg = new Image();
      logoImg.onload = () => {
        // 1. åŸºå‡†å°ºå¯¸
        const borderSize = Math.floor(minSide * 0.04);
        
        // åŸå§‹åº•éƒ¨ç•™ç™½åŸºå‡† (15%)
        let bottomPanelHeight = Math.floor(minSide * 0.15); 
        
        // å­—ä½“åŸºå‡† (3.0%)
        const baseRef = Math.max(24, Math.floor(minSide * 0.03));
        
        // åº”ç”¨ç”¨æˆ·ç¼©æ”¾
        let finalFontSize = baseRef * state.textScale;
        const finalLogoTargetH = (baseRef * 2.0) * state.logoScale; 

        // 2. é¢„è®¡ç®—å†…å®¹é«˜åº¦
        ctx.font = `600 ${finalFontSize}px -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif`;
        const tempCanvasW = imgW + borderSize * 2;
        const maxTextWidth = tempCanvasW * 0.82; 
        
        let lines = layoutTextLines(text, maxTextWidth, finalFontSize);
        let maxLineWidth = 0;
        lines.forEach(l => {
           const w = ctx.measureText(l).width;
           if(w > maxLineWidth) maxLineWidth = w;
        });
        if (maxLineWidth > maxTextWidth) {
           const s = maxTextWidth / maxLineWidth;
           finalFontSize = Math.floor(finalFontSize * s);
        }

        const scale = finalLogoTargetH / logoImg.height;
        const logoH = logoImg.height * scale;
        const logoW = logoImg.width * scale;

        const lineHeight = finalFontSize * 1.5;
        const gapLogoText = finalFontSize * 0.6;
        const gapLines = finalFontSize * 0.2;

        let totalContentH = logoH + gapLogoText + finalFontSize; 
        if (lines.length > 1) {
          totalContentH += (gapLines + finalFontSize * 0.85);
        }

        if (totalContentH + finalFontSize * 1.5 > bottomPanelHeight) {
           bottomPanelHeight = totalContentH + finalFontSize * 1.5;
        }

        // 3. å»ºç«‹çœŸå®ç”»å¸ƒ
        const canvasW = imgW + borderSize * 2;
        const canvasH = imgH + borderSize + bottomPanelHeight;
        canvas.width = canvasW;
        canvas.height = canvasH;

        // 4. ç»˜åˆ¶
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0, 0, canvasW, canvasH);
        ctx.drawImage(img, borderSize, borderSize, imgW, imgH);

        const bottomCenterY = borderSize + imgH + (bottomPanelHeight / 2);
        const startY = bottomCenterY - (totalContentH / 2);

        const logoX = (canvasW - logoW) / 2;
        ctx.drawImage(logoImg, logoX, startY, logoW, logoH);

        ctx.textBaseline = 'top';
        let currentY = startY + logoH + gapLogoText;

        lines.forEach((line, idx) => {
          let currentFontSize = finalFontSize;
          if (idx === 1) currentFontSize = Math.floor(finalFontSize * 0.85);

          const fontWeight = idx === 0 ? '600' : '400';
          const color = idx === 0 ? '#222222' : '#777777';

          ctx.font = `${fontWeight} ${currentFontSize}px -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif`;
          ctx.fillStyle = color;

          const w = ctx.measureText(line).width;
          const x = (canvasW - w) / 2;
          ctx.fillText(line, x, currentY);

          if (idx === 0) currentY += currentFontSize + gapLines;
          else currentY += currentFontSize * 1.4;
        });
      };
      logoImg.src = BLACK_LOGO_SVG;
    }
  </script>
</body>
</html>
